#!/bin/bash
# Xnix 构建运行脚本
#
# 用法:
#   ./run              运行（增量编译）
#   ./run -b           清理重建后运行
#   ./run -n -b -i     只编译 ISO（不运行）
#   ./run -i           ISO 模式运行
#   ./run -d           调试模式
#

set -e

PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"
BUILD_DIR="$PROJECT_ROOT/build"

# 默认配置
CLEAN_BUILD=false
NO_RUN=false
USE_ISO=false
DEBUG=false
CONFIG_PATH=""
QEMU_EXTRA=""
HDA_FILE=""
HDA_INSTALL=""
PACK_BIN=""  # 空表示使用 CMake 默认值

# 帮助信息
show_help() {
    cat << 'EOF'
Xnix 构建运行脚本

用法: ./run [选项]

选项:
  -h, --help          显示帮助
  -b, --build         清理重建（删除 build 目录）
  -n, --no-run        只编译不运行
  -i, --iso           ISO 模式
  -d, --debug         调试模式（GDB 端口 1234）
  -c, --config PATH   用户服务配置路径
  --pack-bin          强制打包 bin 工具到 rootfs.img
  --no-pack-bin       强制不打包 bin 工具（放到 optional）
  --hda FILE          挂载硬盘镜像
  --install SRC       从源镜像复制到 --hda
  --qemu "ARGS"       额外 QEMU 参数

示例:
  ./run               # 增量编译 + 运行
  ./run -b            # 清理重建 + 运行
  ./run -n -b -i      # 清理重建 ISO（只编译）
  ./run -i            # ISO 模式运行
  ./run -d -i         # ISO 调试模式
  ./run --qemu "-m 256M -smp 4"
EOF
}

# 解析参数
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -b|--build)
            CLEAN_BUILD=true
            shift
            ;;
        -n|--no-run)
            NO_RUN=true
            shift
            ;;
        -i|--iso)
            USE_ISO=true
            shift
            ;;
        -d|--debug)
            DEBUG=true
            shift
            ;;
        -c|--config)
            CONFIG_PATH="$2"
            shift 2
            ;;
        --hda)
            HDA_FILE="$2"
            shift 2
            ;;
        --install)
            HDA_INSTALL="$2"
            shift 2
            ;;
        --pack-bin)
            PACK_BIN="ON"
            shift
            ;;
        --no-pack-bin)
            PACK_BIN="OFF"
            shift
            ;;
        --qemu)
            QEMU_EXTRA="$2"
            shift 2
            ;;
        *)
            echo "未知选项: $1"
            echo "使用 --help 查看帮助"
            exit 1
            ;;
    esac
done

JOBS=$(nproc 2>/dev/null || echo 4)

# 清理重建
if $CLEAN_BUILD; then
    echo "清理 build 目录..."
    rm -rf "$BUILD_DIR"
fi

# 初始化构建目录
if [ ! -d "$BUILD_DIR" ]; then
    mkdir -p "$BUILD_DIR"
fi

cd "$BUILD_DIR"

# 配置（如果需要）
if [ ! -f "CMakeCache.txt" ]; then
    echo "配置 CMake..."
    CMAKE_OPTS=""
    if [ -n "$PACK_BIN" ]; then
        CMAKE_OPTS="$CMAKE_OPTS -DPACK_BIN_TO_ROOTFS=$PACK_BIN"
        echo "设置 PACK_BIN_TO_ROOTFS=$PACK_BIN"
    fi
    cmake $CMAKE_OPTS ..
elif [ -n "$PACK_BIN" ]; then
    # 已有 CMakeCache，但用户指定了 PACK_BIN，需要重新配置
    echo "重新配置 CMake（PACK_BIN_TO_ROOTFS=$PACK_BIN）..."
    cmake -DPACK_BIN_TO_ROOTFS=$PACK_BIN ..
fi

# 编译
echo "编译（$JOBS 核心）..."
if $USE_ISO; then
    cmake --build . -j$JOBS --target iso
    cmake --build . -j$JOBS --target optional
else
    cmake --build . -j$JOBS --target xnix.elf --target init.elf
    # 编译核心服务
    cmake --build . -j$JOBS --target seriald.elf --target kbd.elf --target shell.elf 2>/dev/null || true
fi

# 只编译不运行
if $NO_RUN; then
    echo "编译完成"
    exit 0
fi

# 处理自定义配置
if [ -n "$CONFIG_PATH" ]; then
    if [ ! -f "$CONFIG_PATH" ]; then
        echo "错误: 配置文件不存在: $CONFIG_PATH"
        exit 1
    fi
    echo "部署用户配置: $CONFIG_PATH"
    # 复制到 generated 目录，会被打包到 rootfs.img
    cp "$CONFIG_PATH" "$BUILD_DIR/generated/services.conf"
    # 如果使用 ISO，需要重新生成 rootfs
    if $USE_ISO; then
        cmake --build . -j$JOBS --target rootfs
        cmake --build . -j$JOBS --target iso
    fi
fi

# 处理硬盘镜像
if [ -n "$HDA_INSTALL" ]; then
    if [ -z "$HDA_FILE" ]; then
        HDA_FILE="$BUILD_DIR/xnix_disk.img"
    fi
    if [ ! -f "$HDA_INSTALL" ]; then
        echo "错误: 源镜像不存在: $HDA_INSTALL"
        exit 1
    fi
    echo "复制 $HDA_INSTALL -> $HDA_FILE"
    cp "$HDA_INSTALL" "$HDA_FILE"
fi

# 构建 QEMU 命令
QEMU_CMD="qemu-system-i386"
QEMU_ARGS="-serial stdio -no-reboot -m 128M -smp 2"

# 硬盘
if [ -n "$HDA_FILE" ]; then
    if [ ! -f "$HDA_FILE" ]; then
        echo "错误: 硬盘镜像不存在: $HDA_FILE"
        exit 1
    fi
    QEMU_ARGS="$QEMU_ARGS -drive file=$HDA_FILE,format=raw,if=ide"
fi

# 调试模式
if $DEBUG; then
    QEMU_ARGS="$QEMU_ARGS -s -S"
    echo ""
    echo "调试模式：在另一个终端运行:"
    echo "  gdb build/xnix.elf -ex 'target remote :1234'"
    echo ""
fi

# 额外参数
if [ -n "$QEMU_EXTRA" ]; then
    QEMU_ARGS="$QEMU_ARGS $QEMU_EXTRA"
fi

# 运行
if $USE_ISO; then
    echo "从 ISO 启动..."
    echo "QEMU: $QEMU_CMD -cdrom xnix.iso -boot d $QEMU_ARGS"
    $QEMU_CMD -cdrom xnix.iso -boot d $QEMU_ARGS
else
    echo "启动 Xnix..."
    echo "QEMU: $QEMU_CMD -kernel xnix.elf $QEMU_ARGS"
    $QEMU_CMD -kernel xnix.elf $QEMU_ARGS
fi
