#!/bin/bash
# 发布版本构建脚本
#
# 产物:
#   build-release/xnix_installer.iso  — 安装 ISO
#   build-release/disk_template.img   — 可引导磁盘模板
#   build-release/optional/           — 非核心服务

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BUILD_DIR="${SCRIPT_DIR}/build-release"
STRIP="strip"

GREEN='\033[0;32m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }

# 帮助
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    cat << 'EOF'
发布版本构建脚本

用法:
  ./release          构建发布版本
  ./release clean    清理发布构建目录

产物:
  build-release/xnix_installer.iso  安装 ISO
  build-release/disk_template.img   可引导磁盘模板
  build-release/optional/           非核心服务
EOF
    exit 0
fi

# 清理
if [[ "$1" == "clean" ]]; then
    info "清理发布构建目录..."
    rm -rf "$BUILD_DIR"
    info "完成"
    exit 0
fi

# 检查工具
command -v cmake >/dev/null 2>&1 || { echo "需要 cmake"; exit 1; }
command -v grub-mkrescue >/dev/null 2>&1 || echo "警告: grub-mkrescue 未找到"

info "创建发布构建目录: $BUILD_DIR"
rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

info "配置 CMake (Release)..."
cmake "$SCRIPT_DIR" -DCMAKE_BUILD_TYPE=Release -DCFG_DEBUG=OFF

info "编译所有 ELF (并行)..."
make -j"$(nproc)"

info "剥离符号表..."
for elf in *.elf; do
    [[ -f "$elf" ]] || continue
    [[ "$elf" == *".debug" ]] && continue
    cp "$elf" "${elf}.debug"
    $STRIP --strip-all "$elf" 2>/dev/null || true
    info "  $elf: $(stat -c%s "$elf") bytes"
done

info "编译 installer ISO (使用剥离后的 ELF)..."
make -j"$(nproc)" iso_installer

info "编译 optional..."
make -j"$(nproc)" optional 2>/dev/null || true

echo ""
info "发布版本构建完成"
echo ""
echo "产物:"
[[ -f xnix_installer.iso ]] && echo "  安装 ISO:        $BUILD_DIR/xnix_installer.iso ($(du -h xnix_installer.iso | cut -f1))"
[[ -f disk_template.img ]] && echo "  磁盘模板:        $BUILD_DIR/disk_template.img ($(du -h disk_template.img | cut -f1))"
[[ -d optional ]] && echo "  非核心服务:      $BUILD_DIR/optional/"
echo ""
echo "使用方法:"
echo "  安装测试:   qemu-system-i386 -m 128M -cdrom $BUILD_DIR/xnix_installer.iso -hda empty.img -serial stdio"
echo "  磁盘测试:   qemu-system-i386 -m 128M -hda $BUILD_DIR/disk_template.img -serial stdio"
echo "  dd 写入:    sudo dd if=$BUILD_DIR/disk_template.img of=/dev/sdX bs=4M status=progress"
